# テスト方針書（GitHub Actions CIパイプライン / Batch ETL）

## 1. 目的
本方針書は、GiftRecommend MVP のバッチETL実装に対し、GitHub Actions を用いたCIパイプラインとテスト戦略を定義する。  
特に本ETLの設計思想（S3 immutable + staging差分判定 + 冪等性 + is_active一元確定）に沿い、以下を最優先で担保する。

- **差分判定の正しさ（normalize/hash）**
- **冪等性（同一入力の再実行で副作用が増えない）**
- **障害時の原子性（S3失敗時にDB更新しない等）**
- **ジョブ責務境界の逸脱防止（専管テーブル更新ルール）**

---

## 2. 対象範囲
- 対象リポジトリ：バッチETL
- 対象ジョブ：JOB-R-01 / JOB-I-01 / JOB-G-01 / JOB-T-01 / JOB-A-01
- 対象モジュール：
  - `core/`（normalize, hasher, raw_store, config等）
  - `services/`（etl_service, policy, context等）
  - `clients/`（rakuten_client）
  - `repos/`（staging_repo, apl repos）
  - `sql/`（共通SQL）

---

## 3. テストレベル（3層モデル）
本プロジェクトのテストを以下の3層に分割する。

| レベル | 目的 | 主な対象 | CI実行 | 外部依存 |
|---|---|---|---|---|
| Unit | 純粋ロジックの正しさ | normalize/hash/key生成等 | ✅ 必須 | なし |
| Component | 境界・順序・副作用制御 | etl_service + repo/client/store（モック） | ✅ 必須 | なし（モック） |
| Integration | 実接続での動作確認 | DB/S3/楽天APIとの結合 | △ 任意（手動 or 夜間） | あり |

---

## 4. テスト優先順位（MVP）
### 4.1 最重要（必須）
1. **normalizeの安定性**（順序揺れ/欠落/null吸収）
2. **hashの安定性**（同値入力→同一hash、差分のみ変化）
3. **S3 key生成**（案A：key設計の逸脱防止）
4. **ETLの冪等性**（staging一致→S3 putしない / applier呼ばない）
5. **ETLの原子性**（S3 put失敗→staging/apl更新しない）
6. **policy抽出の正しさ**（staging(item)起点でJOINによりgenreId/tagIdを抽出）

### 4.2 重要（できれば）
- DBトランザクション境界の整合（対象単位のロールバック）
- 例外分類（429/5xx/4xx等）の分類精度
- 共通SQLの構文健全性（最低限のlint/parse）

---

## 5. テスト観点（設計思想に対応）
### 5.1 冪等性
- 同一targetを2回処理しても
  - S3 putが増えない
  - stagingが更新されない（差分なし時）
  - apl側applierが呼ばれない（無駄更新防止）

### 5.2 原子性（擬似二相コミット）
- S3 putが成功して初めて staging/apl を更新する
- S3 put失敗時はDB更新を禁止し、再実行で回復可能とする

### 5.3 責務境界
- `apl.item_tag` は JOB-I-01 のみ更新
- `apl.tag(_group)` は JOB-T-01 のみ更新
- `apl.item.is_active` は JOB-A-01 のみ更新

---

## 6. 失敗判定の基本方針（テスト・CI）
### 6.1 CI（テスト）失敗判定
- Unit/Componentテスト：失敗した時点で CI を失敗（exit != 0）
- カバレッジ：MVPでは**必須条件にしない**（ただし測定は推奨）

### 6.2 ジョブ実行時の失敗判定（参考：運用仕様）
- Ranking / Genre / Tag：`failure_rate > 1%` でジョブ失敗扱い（exit != 0）
- is_active：SQL失敗時のみ失敗
※この判定は運用（C-3/C-4）であり、テストでは「サマリ算出が正しい」ことを確認する。

---

## 7. テスト実装方針（Python）
### 7.1 テスティングフレームワーク
- `pytest` を標準とする
- モック：`unittest.mock` を基本（必要に応じて `pytest-mock`）

### 7.2 テスト分類（markers）
- `@pytest.mark.unit`
- `@pytest.mark.component`
- `@pytest.mark.integration`

### 7.3 テストフォルダ構成（例）
```text
tests/
  unit/
    test_hasher.py
    test_normalize_item.py
    test_raw_store_key.py
  component/
    test_etl_skip_when_hash_exists.py
    test_etl_atomicity_on_s3_fail.py
    test_policy_targets_from_today_items.py
  integration/
    test_integration_item_etl_smoke.py
```

## 8. GitHub Actions CIパイプライン方針
### 8.1 トリガー
- `pull_request`：必須（品質ゲート）
- `push`（main）：必須
- `workflow_dispatch`：任意（手動実行）
- Integration：`workflow_dispatch` もしくは `schedule`（夜間）を推奨

### 8.2 CIで実行するジョブ（推奨）
- Lint / Format（任意だが強く推奨）
  - `ruff` / `black` 等（採用するならプロジェクトで統一）
- Unit + Component テスト
  - `pytest -m "unit or component"`
- （任意）SQLチェック
  - `sql/` のファイル存在・命名・最低限の静的検査

### 8.3 Integrationの扱い（MVP）
- PRでは実行しない（外部依存で不安定・費用が出るため）
- 手動 or 夜間で「スモーク」だけ実施
  - 例：dev環境で itemCode 1件のみ
  - 例：S3はdev bucketを使用

---

## 9. テストデータ方針
### 9.1 Unit/Component
- テストデータは固定の dict/JSON をコード内に持つ（最小）
- “順序揺れ”“欠落”“null”“空配列” を含むケースを必ず用意する

### 9.2 Integration
- dev用の最小固定集合（itemCode数件、genreId/tagId数件）
- 本番データを前提にしない

---

## 10. 成果物（Definition of Done）
- CIで Unit/Component が常時緑になる
- normalize/hash/key設計の逸脱をテストで検知できる
- 差分なし時に applier を呼ばないこと、S3失敗時にDB更新しないことをテストで保証できる
- policyの「当日更新分抽出（staging起点JOIN）」をテストで保証できる
- Integrationは手動でもよいが、実施手順がREADME等で再現可能になっている

---

## 11. 運用ルール（推奨）
- 仕様書（C-2, D-1/D-2/D-3）に影響する変更は、対応するテストを同時に更新する
- ETLの“設計の正”は specs/ にあり、CIはそれを破らないことを保証する
- 大きな変更は feature ブランチ＋PRで実施し、main 直pushは禁止を推奨

必要なら、この方針書に合わせて **GitHub Actions の `ci.yml`（pytest markers対応）** と、`pytest.ini` / `pyproject.toml`（ruff/black採用時）まで “コピペで動く形” で一式出します。
