# ログ出力方針

## 1. 目的

本ドキュメントは、アプリケーション（Web / API / Reco）における **ログ出力の基本方針** を定義する。

- 障害・エラー時の原因調査を容易にする
- 本番運用時の監視・アラート基盤の土台とする
- 開発時のデバッグを支援する

---

## 2. 基本原則

| 原則                 | 説明                                                              |
| -------------------- | ----------------------------------------------------------------- |
| エラー時は必ずログ   | 例外・500 等のエラー発生時は、原因特定に必要な情報をログ出力する  |
| 機密情報は出力しない | パスワード、API キー、トークン等はログに含めない                  |
| 構造化を意識         | キー・値形式（`key=value`）で出力し、後から検索・集計しやすくする |
| ログレベルを適切に   | ERROR / WARNING / INFO を使い分ける                               |

---

## 3. ログレベル

| レベル  | 用途                                            |
| ------- | ----------------------------------------------- |
| ERROR   | 例外・想定外エラー。ユーザーへの 500 返却時など |
| WARNING | 想定内の異常（リトライ、フォールバック等）      |
| INFO    | リクエスト受付、処理開始・完了、主要な状態遷移  |
| DEBUG   | 開発時の詳細（本番では通常 OFF）                |

---

## 4. 出力形式

### 4.1 推奨フォーマット

```
[LEVEL] message key1=value1 key2=value2
```

例:

```
[ERROR] recommendation failed request_id=abc-123 step=embedding error=embedding failed: OPENAI_API_KEY is not set
[INFO] recommendation start request_id=abc-123 mode=balanced
[INFO] recommendation done request_id=abc-123 items_count=20 duration_ms=450
```

### 4.2 出力先

- **開発環境**: 標準出力（stdout）
- **本番環境**: 標準出力（コンテナ・サーバー側でファイル・Cloud Logging 等に転送する想定）

---

## 5. コンポーネント別ガイドライン

### 5.1 Reco サービス（Python）

- `logging` モジュールを使用
- ロガー名: `reco.api.handlers` 等、モジュールパスに合わせる
- エラー時: `logger.exception()` でスタックトレースも出力
- リクエスト開始・完了: `request_id` を付与してトレース可能に

### 5.2 API（Node.js / Express）

- `console.error` または `pino` / `winston` 等のロガーを使用
- エラー時: エラーメッセージ・スタックを出力
- リクエスト ID や `recommendationId` を付与してトレース可能に

### 5.3 Web（Next.js）

- クライアント側: 本番では機密情報に注意し、必要最小限
- サーバー側: API 呼び出し失敗時等にログ

---

## 6. エラー時の必須出力項目

500 等のエラー発生時は、以下を可能な限り含める。

| 項目             | 説明                                                      |
| ---------------- | --------------------------------------------------------- |
| エラーメッセージ | 例外メッセージ・detail                                    |
| ステップ         | どの処理で失敗したか（embedding, supabase_query, mmr 等） |
| リクエスト識別子 | request_id, recommendationId 等                           |
| スタックトレース | 開発・検証環境では出力（本番では要検討）                  |

---

## 7. 変更履歴

| 日付       | 内容     |
| ---------- | -------- |
| 2025-02-12 | 初版作成 |
