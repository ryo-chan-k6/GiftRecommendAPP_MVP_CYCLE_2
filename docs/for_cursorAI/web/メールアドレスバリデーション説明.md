# メールアドレスバリデーション 詳細説明

## 1. invalid エラーの原因（testUser01@test.com の場合）

Supabase Auth は **`email_address_invalid`** エラーを返します。

公式ドキュメントの説明:
> **Example and test domains are currently not supported. Use a different email address.**

つまり、**`test.com` は Supabase がブロックしている「テスト/例示用ドメイン」** のため、登録できません。

---

## 2. バリデーションの二重構造

| 段階 | 実施者 | 目的 |
|------|--------|------|
| 1. クライアント側 | RegisterForm.tsx | フォーマットの事前チェック、UX 向上 |
| 2. サーバー側 | Supabase Auth API | ドメイン制限・セキュリティ |

---

## 3. クライアント側バリデーション（RegisterForm.tsx）

### 3.1 現在の正規表現

```ts
const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
```

### 3.2 解釈

| 部分 | 正規表現 | 意味 |
|-----|----------|------|
| `^` | 先頭 | 文字列の開始 |
| `[^\s@]+` | ローカル部 | スペース・@ 以外を 1 文字以上 |
| `@` | アットマーク | 必須 |
| `[^\s@]+` | ドメイン名 | スペース・@ 以外を 1 文字以上 |
| `\.` | ドット | 必須（エスケープ） |
| `[^\s@]+` | TLD | スペース・@ 以外を 1 文字以上 |
| `$` | 末尾 | 文字列の終了 |

### 3.3 具体例

| メールアドレス | 結果 | 理由 |
|----------------|------|------|
| `testUser01@test.com` | ✅ 通過 | ローカル・@・ドメイン・TLD が揃っている |
| `user@example.com` | ✅ 通過 | 同上 |
| `a@a.com` | ✅ 通過 | 同上 |
| ` @test.com` | ❌ 不合格 | ローカル部にスペース |
| `user@` | ❌ 不合格 | ドメインなし |
| `user@domain` | ❌ 不合格 | TLD なし（`.` がない） |
| `user@domain.` | ❌ 不合格 | TLD が空 |

### 3.4 制限しているもの

- 先頭・末尾のスペース（`trim()` で除去）
- 空文字
- 基本的なメール形式（`local@domain.tld`）

---

## 4. Supabase Auth 側のバリデーション

### 4.1 エラーコード

| コード | 説明 |
|--------|------|
| `email_address_invalid` | 例示・テスト用ドメインは非対応。別のメールアドレスを使用すること |

### 4.2 ブロックされているドメイン（推定）

Supabase がブロックしているとされるドメイン例:

- `test.com`
- `example.com`
- `example.org`
- `example.net`
- その他の例示・テスト用ドメイン

※ ドメイン一覧は非公開のため、完全なリストは不明です。

### 4.3 その他の制限

- ローカル部・ドメインの長さ制限
- 不正な文字の排除
- フォーマットの検証

---

## 5. テスト時の推奨事項

### 5.1 登録できるメールアドレス

| 用途 | 例 |
|------|-----|
| 開発・テスト | 自身の Gmail、Yahoo!、Outlook など |
| 一時メール | mailinator.com、guerrillamail.com など（ブロックされない場合） |

### 5.2 使わないほうがよいドメイン

- `test.com`
- `example.com` / `example.org` / `example.net`
- `a.com` など短すぎるドメイン

---

## 6. 参考文献

- [Supabase Error Codes - email_address_invalid](https://supabase.com/docs/guides/auth/debugging/error-codes)
- [GitHub Issue: Email address "a@a.com" is invalid](https://github.com/supabase/auth/issues/2252)
