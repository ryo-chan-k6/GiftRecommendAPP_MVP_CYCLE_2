# ユーザー登録画面 仕様書

## 1. 概要

一般ユーザー用および管理者用の2種類の登録画面を用意し、Supabase Auth および `apl.user_profile` との同期を実現する。

---

## 2. 画面構成

| 画面 | 用途 | ルート | 登録後の role |
|------|------|--------|---------------|
| 一般ユーザー登録 | 一般ユーザー向け | `/register` | `USER` |
| 管理者登録 | 管理者向け | `/register/admin` | `ADMIN` |

---

## 3. データベース

### 3.1 auth.users（Supabase 管理）

- `supabase.auth.signUp()` によって insert される
- 本仕様では直接操作しない

### 3.2 apl.user_profile

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| id | uuid | PK, FK → auth.users(id) | ユーザー ID（auth.users と同一） |
| name | varchar | NOT NULL | 表示名 |
| role | varchar | DEFAULT 'USER' | `USER` / `ADMIN` |
| created_at | timestamptz | NOT NULL DEFAULT now() | 作成日時 |

### 3.3 登録フロー（トランザクション整合性）

**同一トランザクションで管理**: `auth.users` と `apl.user_profile` の整合性を保つため、**Database Trigger** を使用する。

```
1. クライアント: signUp({ email, password, options: { data: { display_name, role } } })
   → Supabase Auth が auth.users に insert

2. DB トリガー（auth.users AFTER INSERT）が発火:
   → apl.user_profile に insert（同一トランザクション内）
   → トリガー失敗時は auth.users の insert もロールバック（整合性保証）

3. 両方成功した場合のみコミット
```

クライアントは **signUp のみ** を呼び出す。user_profile はトリガーで自動作成される。

---

## 4. 入力項目

| 項目 | 必須 | 備考 |
|------|------|------|
| メールアドレス | ○ | バリデーション: 有効な形式 |
| パスワード | ○ | パスワードポリシー（Supabase 設定に準拠） |
| 表示名（name） | ○ | apl.user_profile.name に格納 |

※ パスワード確認は UX のため推奨（実装判断）

---

## 5. API フロー

### 5.1 クライアント側処理

`signUp` のみ呼び出す。`user_profile` はトリガーで自動作成される。

```ts
const { data, error } = await supabase.auth.signUp({
  email,
  password,
  options: {
    data: {
      display_name: name,        // apl.user_profile.name に格納
      role: isAdmin ? "ADMIN" : "USER",  // apl.user_profile.role に格納
    },
  },
});
```

### 5.2 Database Trigger（apl.user_profile 自動作成）

`auth.users` への INSERT 発生時に、同一トランザクション内で `apl.user_profile` を insert するトリガーを定義する。

```sql
-- トリガー関数（SECURITY DEFINER で RLS を bypass）
create or replace function apl.handle_new_user_profile()
returns trigger language plpgsql security definer set search_path = apl
as $$
declare
  v_name text := trim(coalesce(new.raw_user_meta_data->>'display_name', ''));
  v_role text := coalesce(nullif(trim(new.raw_user_meta_data->>'role'), ''), 'USER');
begin
  if v_name = '' then
    raise exception 'display_name is required';
  end if;
  insert into apl.user_profile (id, name, role)
  values (new.id, v_name, v_role);
  return new;
end;
$$;

-- トリガー登録
create or replace trigger on_auth_user_created
  after insert on auth.users
  for each row
  execute procedure apl.handle_new_user_profile();
```

- **DDL ファイル**: `docs/db/trigger_user_profile_on_auth_signup.sql`
- **整合性**: トリガーが失敗すると auth.users の insert もロールバックされる
- **name 必須**: `display_name` が空の場合はトリガーでエラーにすることも検討（NOT NULL 制約で弾かれる）

### 5.3 RLS について

- トリガーは `SECURITY DEFINER` により、RLS を経由せず insert 可能
- クライアントからの user_profile insert は不要（トリガーで完結）

---

## 6. 管理者登録のセキュリティ

| リスク | 対策 |
|--------|------|
| 誰でも `/register/admin` にアクセス可能 | MVP 段階では URL を非公開にする、または招待コードを導入する |

**推奨案（MVP）:**

1. 管理者登録は招待制（招待コード・シークレット）を検討
2. または本番では `/register/admin` を無効化し、初期管理者のみ DB で直接設定

---

## 7. 遷移

| 遷移元 | 遷移先 |
|--------|--------|
| ログイン画面 | `/login` ↔ `/register` へのリンク |
| 登録完了後 | 成功時: トップ・推薦画面などへ redirect |
| 登録失敗時 | 同一画面にエラーメッセージ表示 |

---

## 8. エラーハンドリング

| エラー | 対応 |
|--------|------|
| signUp 失敗（email 重複等） | エラーメッセージ表示、再入力促す |
| トリガー失敗（例: name が空で NOT NULL 違反） | auth.users の insert もロールバックされ、signUp は失敗として返る。整合性は保たれる |

同一トランザクションのため、**auth.users と user_profile の不整合は発生しない**。

---

## 9. 実装上の注意

1. **トリガー DDL**: マイグレーション等でトリガーを DB に適用しておくこと
2. **メール確認**: Supabase の Email Confirmation が有効でも、auth.users への insert は signUp 呼び出し時に発生するため、トリガーはその時点で実行される
3. **display_name 必須**: クライアント側で必須バリデーションを行う。空の場合はトリガー内で `raise exception` してロールバックさせることも可能
