# FastAPI 疎通確認エラー調査ガイド

## 修正内容

### 1. FastAPI 側の修正 (`apps/reco/src/main.py`)

- **CORS ミドルウェアを追加**: ブラウザからのリクエストを許可するため

### 2. フロントエンド側の修正 (`apps/web/app/page.tsx`)

- **レスポンスデータの処理を追加**: `fetchHealthReco`関数でレスポンス JSON を処理するように修正
- **デバッグログを追加**: ブラウザコンソールでエラー詳細を確認できるように

## 原因調査の手順

### ステップ 1: ブラウザの開発者ツールで確認

1. **コンソールタブを開く**

   - `F12`キーを押すか、右クリック → 「検証」
   - 「Console」タブを選択
   - 以下のログが表示されるか確認：
     - `🔄 Reco API へのリクエスト開始`
     - `📡 Reco API レスポンス`（成功時）
     - `❌ Reco API エラー`（エラー時）
     - `❌ Reco API 例外`（例外発生時）

2. **ネットワークタブで確認**
   - 「Network」タブを選択
   - ページをリロード
   - `health`リクエストを探す
   - クリックして以下の情報を確認：
     - **Status**: HTTP ステータスコード（200 が正常）
     - **Headers**:
       - `Request Headers`: リクエストヘッダー
       - `Response Headers`: `Access-Control-Allow-Origin`があるか確認
     - **Response**: レスポンスボディの内容
     - **Preview**: JSON 形式で表示される内容

### ステップ 2: サーバー側のログを確認

#### FastAPI サーバー（ポート 3002）の起動

```bash
cd apps/reco
uvicorn src.main:app --reload --port 3002
```

#### 確認ポイント

- サーバーが正常に起動しているか
- リクエストが届いているか
- エラーログが出力されていないか

### ステップ 3: よくあるエラーと対処法

#### エラー 1: `Failed to fetch` または `NetworkError`

**原因**:

- FastAPI サーバーが起動していない
- ポート番号が間違っている（3002 で起動しているか確認）
- CORS 設定が不足している

**対処法**:

```bash
# FastAPIサーバーが起動しているか確認
curl http://localhost:3002/health
```

#### エラー 2: `CORS policy: No 'Access-Control-Allow-Origin' header`

**原因**: CORS 設定が不足している

**対処法**: `main.py`に CORS ミドルウェアが追加されているか確認（既に修正済み）

#### エラー 3: `404 Not Found`

**原因**:

- エンドポイントパスが間違っている
- FastAPI のルーティング設定が間違っている

**対処法**:

```bash
# FastAPIのドキュメントを確認
# ブラウザで http://localhost:3002/docs にアクセス
```

#### エラー 4: `500 Internal Server Error`

**原因**: FastAPI 側で例外が発生している

**対処法**: FastAPI サーバーのログを確認

### ステップ 4: 手動で疎通確認

#### curl コマンドでテスト

```bash
# FastAPIのヘルスチェック
curl -v http://localhost:3002/health

# Express APIのヘルスチェック（比較用）
curl -v http://localhost:3001/health
```

#### Postman や Thunder Client でテスト

- URL: `http://localhost:3002/health`
- Method: `GET`
- レスポンスが返ってくるか確認

### ステップ 5: 環境変数とポート番号の確認

1. **FastAPI サーバーの起動ポート**

   - `apps/reco/src/main.py`でポート設定を確認
   - デフォルトは`3002`

2. **フロントエンドのリクエスト先**
   - `apps/web/app/page.tsx`の`fetch`URL を確認
   - `http://localhost:3002/health`になっているか

## デバッグのコツ

1. **段階的に確認**

   - まずサーバーが起動しているか
   - 次にブラウザからのリクエストが届いているか
   - 最後にレスポンスが正しく返っているか

2. **ログを活用**

   - ブラウザコンソールのログ
   - サーバー側のログ
   - ネットワークタブの詳細

3. **シンプルなテストから**
   - `curl`で直接テスト
   - ブラウザで直接 URL にアクセス
   - 徐々に複雑なケースに移行

## 現在のコードの動作

修正後のコードは以下のように動作します：

1. ページが読み込まれると、自動的に両方の API（ポート 3001 と 3002）にリクエストを送信
2. ブラウザコンソールに詳細なログが表示される
3. エラーが発生した場合、エラーメッセージが画面に表示される
4. 成功した場合、ヘルスチェックの結果が表示される

## 次のステップ

エラーが解決しない場合：

1. ブラウザコンソールのエラーメッセージをコピー
2. ネットワークタブのリクエスト/レスポンスをスクリーンショット
3. FastAPI サーバーのログを確認
4. 上記の情報を元に詳細な原因を調査
