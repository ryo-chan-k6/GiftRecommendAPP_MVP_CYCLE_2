# ユーザー登録画面 実装計画

## 1. 実装タスク一覧

| # | タスク | 内容 |
|---|--------|------|
| 0 | DB トリガー適用 | auth.users 作成時に user_profile を自動作成するトリガー |
| 1 | 登録フォームコンポーネント | 共通のフォーム UI・バリデーション |
| 2 | 一般ユーザー登録ページ | `/register` |
| 3 | 管理者登録ページ | `/register/admin` |
| 4 | 登録処理 | signUp（options.data に display_name, role を渡す） |
| 5 | ログイン画面へのリンク追加 | 登録画面へ遷移 |

---

## 2. ファイル構成

```
apps/web/src/
├── app/
│   ├── register/
│   │   ├── page.tsx          # 一般ユーザー登録
│   │   └── admin/
│   │       └── page.tsx      # 管理者登録
│   └── login/
│       └── page.tsx          # 既存: 登録へのリンク追加
├── components/
│   └── register/
│       └── RegisterForm.tsx   # 共通フォーム（role を props で受け取る）
└── lib/
    └── supabaseClient.ts      # 既存
```

---

## 3. コンポーネント設計

### 3.1 RegisterForm

| Props | 型 | 説明 |
|-------|------|------|
| role | `USER` \| `ADMIN` | 登録後 apl.user_profile.role |
| redirectPath | string | 登録成功時の遷移先 |

**内部状態**:
- email, password, name
- エラーメッセージ
- ローディング状態

**処理**:
1. バリデーション（email 形式、password 長さ、name 必須）
2. `supabase.auth.signUp({ email, password, options: { data: { display_name: name, role } } })`
   - user_profile はトリガーで自動作成（同一トランザクション）
3. 成功時: `router.push(redirectPath)` または `redirect()`

### 3.2 ページ

- `/register/page.tsx`: `<RegisterForm role="USER" redirectPath="/" />` など
- `/register/admin/page.tsx`: `<RegisterForm role="ADMIN" redirectPath="/" />` など

---

## 4. 実装順序

1. **DB トリガー** をマイグレーションで適用（先行必須）
2. **RegisterForm** 共通コンポーネント作成
3. **一般ユーザー登録** `/register/page.tsx`
4. **管理者登録** `/register/admin/page.tsx`
5. **ログイン画面** に「新規登録」リンク追加

---

## 5. 技術的注意点

### 5.1 DB トリガー（必須）

- `auth.users` へ INSERT 時に `apl.user_profile` を自動作成
- signUp と user_profile は同一トランザクションで整合性を保証
- DDL: `docs/db/trigger_user_profile_on_auth_signup.sql`

### 5.2 signUp の options.data

- `display_name`: user_profile.name
- `role`: `USER` または `ADMIN`（登録画面に応じて渡す）

### 5.3 クライアントからの user_profile insert は不要

- トリガーで完結するため、クライアントは signUp のみ呼び出す

---

## 6. 参照

- [仕様書](./ユーザー登録画面仕様.md)
- [Supabase Auth signUp](https://supabase.com/docs/reference/javascript/auth-signup)
- [rls_policy.md](../../online/rls_policy.md)
