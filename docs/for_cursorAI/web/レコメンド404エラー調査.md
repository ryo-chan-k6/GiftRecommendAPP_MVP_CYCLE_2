# レコメンド実行 404 エラー 原因調査

## リクエストフロー

```
[Web (Vercel)] --POST /recommendations--> [API (Render)] --POST /recommendations--> [Reco (Fly.io)]
```

- **Web**: `NEXT_PUBLIC_API_BASE_URL` を使って API に POST
- **API**: `RECO_BASE_URL` を使って Reco に POST

## 404 かつ全サービスにログがない場合の想定原因

### 1. リクエストが Render に届いていない（最有力）

**原因**: `NEXT_PUBLIC_API_BASE_URL` が Vercel で未設定、または誤設定

- **未設定**: ビルド時に `undefined` となり、`fetch("undefined/recommendations")` が相対 URL として解釈され、**Vercel のドメイン** に送信される
- **結果**: Vercel の Next.js に `/recommendations` は存在しないため **404**
- **ログ**: Vercel/Render/Fly.io いずれにも API 呼び出しログは出ない（Vercel は 404 を返すだけ）

### 2. 環境変数の確認ポイント

| サービス | 変数名 | 想定値 | 用途 |
|---------|--------|--------|------|
| Vercel (Web) | `NEXT_PUBLIC_API_BASE_URL` | `https://<RenderのAPI名>.onrender.com` | Web → API |
| Render (API) | `RECO_BASE_URL` | `https://<Fly.ioのReco名>.fly.dev` | API → Reco |

### 3. 確認手順

#### Step 1: ブラウザの開発者ツールで実際のリクエスト先を確認

1. recommend ページを開く
2. 開発者ツール → Network タブを開く
3. 「レコメンドを実行」をクリック
4. 失敗したリクエストを選択し、**Request URL** を確認

- `https://<あなたのVercelドメイン>/recommendations` → **原因1**（API URL 未設定）
- `https://<RenderのURL>/recommendations` → Render 側の設定やルーティングを確認

#### Step 2: Vercel の環境変数確認

1. Vercel ダッシュボード → プロジェクト → Settings → Environment Variables
2. `NEXT_PUBLIC_API_BASE_URL` が **Production** に設定されているか確認
3. 値が `https://xxx.onrender.com` 形式か確認（末尾スラッシュなし）

#### Step 3: 環境変数変更後の再デプロイ

`NEXT_PUBLIC_*` はビルド時に埋め込まれるため、変更後は **再デプロイ** が必要。

## 想定される修正

1. Vercel に `NEXT_PUBLIC_API_BASE_URL` を設定
2. 値: Render の API URL（例: `https://gift-reco-api-xxxx.onrender.com`）
3. 再デプロイを実行
