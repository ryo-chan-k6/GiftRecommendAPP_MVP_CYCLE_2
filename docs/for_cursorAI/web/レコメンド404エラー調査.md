# レコメンド実行 404 エラー 原因調査

## リクエストフロー

```
[Web (Vercel)] --POST /recommendations--> [API (Render)] --POST /recommendations--> [Reco (Fly.io)]
```

- **Web**: `NEXT_PUBLIC_API_BASE_URL` を使って API に POST
- **API**: `RECO_BASE_URL` を使って Reco に POST

## 本番環境で 404 になる場合の診断

開発環境では動くが本番で 404 になる場合、**環境変数の未設定・誤設定**が最も多い原因です。

### 診断 Step 1: ブラウザでリクエスト先を確認

1. 本番の recommend ページを開く
2. 開発者ツール → Network タブを開く
3. 「レコメンドを実行」をクリック
4. 失敗したリクエストの **Request URL** を確認

| Request URL | 原因 |
|-------------|------|
| `https://<Vercelドメイン>/recommendations` | **Vercel の NEXT_PUBLIC_API_BASE_URL 未設定**。リクエストが Vercel に飛んでいる |
| `https://<RenderのURL>/recommendations` | Web → API は届いている。**API → Reco の 404** の可能性 |

### 診断 Step 2: エラーメッセージの内容を確認

- `API error 404: Reco service error (Reco URL が誤っている可能性...)`  
  → **Render の RECO_BASE_URL** が誤っている、または Fly.io Reco の URL が正しくない

- `API error 404: ... (URL: https://xxx.onrender.com/recommendations)`  
  → その URL に Render が応答していない（サービス停止・URL 誤り）

### 環境変数チェックリスト（本番）

| サービス | 変数名 | 想定値 | 確認方法 |
|---------|--------|--------|----------|
| **Vercel** (Web) | `NEXT_PUBLIC_API_BASE_URL` | `https://gift-reco-api.onrender.com`（末尾スラッシュなし） | Vercel → プロジェクト → Settings → Environment Variables。**Production** に設定されているか |
| **Render** (API) | `RECO_BASE_URL` | `https://gift-reco-twilight-haze-4343.fly.dev`（末尾スラッシュなし） | Render → サービス → Environment。Fly.io の Reco アプリ URL |

### 本番でよくある原因

1. **Vercel**: `NEXT_PUBLIC_API_BASE_URL` が Production に未設定
   - Preview/Development のみ設定していると、本番ビルドでは `undefined` になる
2. **Vercel**: 環境変数変更後に再デプロイしていない
   - `NEXT_PUBLIC_*` はビルド時に埋め込まれるため、変更後は必ず再デプロイ
3. **Render**: `RECO_BASE_URL` が未設定または誤り
   - Fly.io の Reco アプリ URL を正確に設定（`https://<app名>.fly.dev`）
4. **Fly.io**: Reco アプリがスリープ中で初回リクエストがタイムアウト
   - `min_machines_running = 0` の場合、アイドル時に停止。初回は起動に数十秒かかることがある

### 修正手順

1. **Vercel**: `NEXT_PUBLIC_API_BASE_URL` を Production に設定し、再デプロイ
2. **Render**: `RECO_BASE_URL` を Fly.io の Reco URL に設定
3. 各サービスのログで 404 の発生箇所を確認
   - Render: Logs で `Reco service error` が出ていれば API → Reco で失敗
   - Fly.io: `flyctl logs --app gift-reco-twilight-haze-4343` で Reco にリクエストが届いているか確認
