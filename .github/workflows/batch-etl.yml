name: batch-etl

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target env"
        required: true
        default: "dev"
        type: choice
        options: ["dev", "prod"]
  # schedule:
  #   # NOTE: cron is UTC. 00:00 JST = 15:00 UTC (previous day)
  #   # dev schedule: 00:30 JST = 15:30 UTC (previous day)
  #   - cron: "30 15 * * *"

env:
  TARGET_ENV: ${{ inputs.env }}

concurrency:
  group: batch-etl-${{ github.workflow }}-${{ inputs.env }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  job_ranking:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run JOB-R-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_RAW_DEV: ${{ secrets.S3_BUCKET_RAW_DEV }}
          S3_BUCKET_RAW_PROD: ${{ secrets.S3_BUCKET_RAW_PROD }}
        run: python -m jobs.ranking_job

  job_item:
    runs-on: ubuntu-latest
    needs: [job_ranking]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run JOB-I-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_RAW_DEV: ${{ secrets.S3_BUCKET_RAW_DEV }}
          S3_BUCKET_RAW_PROD: ${{ secrets.S3_BUCKET_RAW_PROD }}
        run: python -m jobs.item_job

  job_genre:
    runs-on: ubuntu-latest
    needs: [job_item]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run JOB-G-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_RAW_DEV: ${{ secrets.S3_BUCKET_RAW_DEV }}
          S3_BUCKET_RAW_PROD: ${{ secrets.S3_BUCKET_RAW_PROD }}
        run: python -m jobs.genre_job

  job_tag:
    runs-on: ubuntu-latest
    needs: [job_item]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run JOB-T-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_RAW_DEV: ${{ secrets.S3_BUCKET_RAW_DEV }}
          S3_BUCKET_RAW_PROD: ${{ secrets.S3_BUCKET_RAW_PROD }}
        run: python -m jobs.tag_job

  job_is_active:
    runs-on: ubuntu-latest
    needs: [job_genre, job_tag]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Run JOB-A-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python -m jobs.is_active_job

  job_embedding_source:
    runs-on: ubuntu-latest
    needs: [job_is_active]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Run JOB-E-01
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python -m jobs.embedding_source_job

  job_embedding_build:
    runs-on: ubuntu-latest
    needs: [job_embedding_source]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.3

      - name: Install dependencies
        working-directory: apps/batch
        run: pip install -r requirements.txt

      - name: Run JOB-E-02
        working-directory: apps/batch/etl
        env:
          ENV: ${{ env.TARGET_ENV || 'prod' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_EMBEDDING_MODEL: ${{ secrets.OPENAI_EMBEDDING_MODEL }}
          OPENAI_TIMEOUT_SEC: ${{ secrets.OPENAI_TIMEOUT_SEC }}
          OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES }}
          OPENAI_BACKOFF_BASE_SEC: ${{ secrets.OPENAI_BACKOFF_BASE_SEC }}
        run: python -m jobs.embedding_build_job
